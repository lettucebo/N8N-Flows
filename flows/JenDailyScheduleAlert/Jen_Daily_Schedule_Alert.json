{
  "name": "Jen Daily Schedule Alert",
  "nodes": [
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1B19nehOp-PMweCWRcsyEne5Ih1dztN6Zc4JEp2ZgxsY",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Sheet1",
          "mode": "name"
        },
        "options": {}
      },
      "id": "cad75dff-5113-4b13-a352-83d579d3967a",
      "name": "è®€å–æ’ç­è¡¨",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        220,
        0
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "uaKbWsktDQm9340w",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Jen æ’ç­é€šçŸ¥è™•ç†é‚è¼¯ - ä¿®æ­£æ™‚å€åˆ¤æ–·é‚è¼¯ï¼ˆå«å¤ä»¤æ™‚ï¼‰\nconst items = $input.all();\n\nconsole.log('=== è³‡æ–™çµæ§‹åˆ†æ ===');\nconsole.log('items é•·åº¦:', items.length);\n\n// ğŸ• å‹•æ…‹æ™‚å€åç§»å‡½æ•¸ï¼ˆè™•ç†å¤ä»¤æ™‚ï¼‰\nfunction getCalgaryOffset(date) {\n  const year = date.getFullYear();\n  \n  // è¨ˆç®—å¤ä»¤æ™‚é–‹å§‹ï¼š3æœˆç¬¬äºŒå€‹é€±æ—¥\n  const marchFirst = new Date(year, 2, 1); // 3æœˆ1æ—¥\n  const firstSunday = 7 - marchFirst.getDay();\n  const secondSunday = firstSunday + 7;\n  const dstStart = new Date(year, 2, secondSunday, 2, 0, 0); // 3æœˆç¬¬äºŒå€‹é€±æ—¥ 2:00 AM\n  \n  // è¨ˆç®—å¤ä»¤æ™‚çµæŸï¼š11æœˆç¬¬ä¸€å€‹é€±æ—¥\n  const novemberFirst = new Date(year, 10, 1); // 11æœˆ1æ—¥\n  const novFirstSunday = 7 - novemberFirst.getDay();\n  const dstEnd = new Date(year, 10, novFirstSunday, 2, 0, 0); // 11æœˆç¬¬ä¸€å€‹é€±æ—¥ 2:00 AM\n  \n  // åˆ¤æ–·æ˜¯å¦åœ¨å¤ä»¤æ™‚æœŸé–“\n  if (date >= dstStart && date < dstEnd) {\n    console.log('ğŸŒ å¡åŠ åˆ©å¤ä»¤æ™‚æœŸé–“ (MDT): UTC-6');\n    return -6 * 60; // UTC-6 (Mountain Daylight Time)\n  } else {\n    console.log('â„ï¸ å¡åŠ åˆ©æ¨™æº–æ™‚æœŸé–“ (MST): UTC-7');\n    return -7 * 60; // UTC-7 (Mountain Standard Time)\n  }\n}\n\n// æ™‚å€è¨­ç½®\nconst taipeiOffset = 8 * 60; // UTC+8 (åˆ†é˜)\nconst now = new Date();\nconst calgaryOffset = getCalgaryOffset(now); // å‹•æ…‹è¨ˆç®—å¡åŠ åˆ©æ™‚å€\n\n// å–å¾—ç•¶å‰æ™‚é–“\nconst taipeiNow = new Date(now.getTime() + (taipeiOffset * 60000));\nconst calgaryNow = new Date(now.getTime() + (calgaryOffset * 60000));\n\nconsole.log('ğŸŒ æ™‚å€è³‡è¨Š:');\nconsole.log('å°åŒ—æ™‚å€åç§»:', taipeiOffset / 60, 'å°æ™‚');\nconsole.log('å¡åŠ åˆ©æ™‚å€åç§»:', calgaryOffset / 60, 'å°æ™‚');\n\n// ğŸ¯ æ–°çš„æ™‚é–“åˆ¤æ–·é‚è¼¯\nconst taipeiHour = taipeiNow.getHours();\nlet targetDate;\nlet displayDay;\nlet isShowingTomorrow;\n\nif (taipeiHour >= 8 && taipeiHour <= 19) {\n  // å°åŒ— 08:00-19:59 â†’ é¡¯ç¤ºå¡åŠ åˆ©ã€Œæ˜å¤©ã€ç­è¡¨\n  const calgaryTomorrow = new Date(calgaryNow);\n  calgaryTomorrow.setDate(calgaryTomorrow.getDate() + 1);\n  targetDate = calgaryTomorrow.toISOString().split('T')[0];\n  displayDay = 'æ˜å¤©';\n  isShowingTomorrow = true;\n  console.log('ğŸŒ… å°åŒ—ç™½å¤©æ™‚æ®µ (08:00-19:59) - é¡¯ç¤ºå¡åŠ åˆ©æ˜å¤©ç­è¡¨');\n} else {\n  // å°åŒ— 20:00-07:59 â†’ é¡¯ç¤ºå¡åŠ åˆ©ã€Œä»Šå¤©ã€ç­è¡¨\n  targetDate = calgaryNow.toISOString().split('T')[0];\n  displayDay = 'ä»Šå¤©';\n  isShowingTomorrow = false;\n  console.log('ğŸŒ™ å°åŒ—å¤œé–“æ™‚æ®µ (20:00-07:59) - é¡¯ç¤ºå¡åŠ åˆ©ä»Šå¤©ç­è¡¨');\n}\n\nconsole.log('å°åŒ—ç•¶å‰æ™‚é–“:', taipeiNow.toISOString());\nconsole.log('å¡åŠ åˆ©ç•¶å‰æ™‚é–“:', calgaryNow.toISOString());\nconsole.log('ç›®æ¨™æ—¥æœŸ:', targetDate);\nconsole.log('é¡¯ç¤ºå¤©æ•¸:', displayDay);\nconsole.log('å°åŒ—å°æ™‚:', taipeiHour);\n\n// æ”¶é›†æ‰€æœ‰è³‡æ–™\nconst scheduleData = [];\n\nconsole.log('é–‹å§‹è™•ç†æ‰€æœ‰ items...');\n\n// ç›´æ¥è™•ç†æ¯å€‹ itemï¼ˆæ¯å€‹ item ä»£è¡¨ä¸€è¡Œè³‡æ–™ï¼‰\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const row = item.json;\n  \n  console.log(`è™•ç†ç¬¬ ${i+1} å€‹ item:`, JSON.stringify(row, null, 2));\n  \n  // è·³éç„¡æ•ˆè³‡æ–™\n  if (!row || !row.Employee || !row.Date) {\n    console.log(`è·³éç¬¬ ${i+1} å€‹ item (ç„¡å“¡å·¥åç¨±æˆ–æ—¥æœŸ)`);\n    continue;\n  }\n  \n  const employee = row.Employee;\n  const dateStr = row.Date;\n  const day = row.Day;\n  const shiftTime = row.Shift_Time;\n  const status = row.Status;\n  const location = row.Manager_Location;\n  \n  console.log(`è™•ç†å“¡å·¥: ${employee}, æ—¥æœŸ: ${dateStr}, ç­æ¬¡: ${shiftTime}, ç‹€æ…‹: ${status}, ä½ç½®: ${location}`);\n  \n  // æ—¥æœŸæ ¼å¼è½‰æ›\n  let formattedDate = '';\n  if (dateStr && dateStr.includes('/')) {\n    try {\n      const parts = dateStr.split('/');\n      if (parts.length === 3) {\n        const month = parts[0].padStart(2, '0');\n        const day = parts[1].padStart(2, '0');\n        const year = parts[2];\n        formattedDate = `${year}-${month}-${day}`;\n        console.log(`æ—¥æœŸè½‰æ›: ${dateStr} â†’ ${formattedDate}`);\n      }\n    } catch (e) {\n      console.log('æ—¥æœŸè§£æéŒ¯èª¤:', dateStr);\n      continue;\n    }\n  }\n  \n  if (formattedDate && employee) {\n    const processedRow = {\n      employee: employee.trim(),\n      date: formattedDate,\n      day: day,\n      shiftTime: shiftTime || '',\n      status: status || '',\n      location: location || ''\n    };\n    \n    scheduleData.push(processedRow);\n    console.log(`âœ… æˆåŠŸè™•ç†:`, processedRow);\n  }\n}\n\nconsole.log('è™•ç†å¾Œçš„ scheduleData é•·åº¦:', scheduleData.length);\nconsole.log('å‰5ç­†è™•ç†å¾Œçš„è³‡æ–™:', scheduleData.slice(0, 5));\n\n// æ‰¾å‡ºç›®æ¨™æ—¥æœŸçš„ç­è¡¨\nconst targetSchedules = scheduleData.filter(item => \n  item.date === targetDate\n);\n\nconsole.log(`${displayDay}çš„ç­è¡¨ç­†æ•¸:`, targetSchedules.length);\nconsole.log(`${displayDay}çš„æ‰€æœ‰ç­è¡¨:`, targetSchedules);\n\n// æ‰¾å‡º Jen çš„ç­è¡¨\nconst jenTargetSchedule = targetSchedules.find(item => \n  item.employee && item.employee.toLowerCase().includes('jen')\n);\n\n// æ‰¾å‡ºå…¶ä»–åŒäº‹çš„ç­è¡¨\nconst othersTargetSchedules = targetSchedules.filter(item => \n  item.employee && !item.employee.toLowerCase().includes('jen')\n);\n\nconsole.log(`Jen ${displayDay}ç­è¡¨:`, jenTargetSchedule);\nconsole.log(`å…¶ä»–åŒäº‹${displayDay}ç­è¡¨æ•¸é‡:`, othersTargetSchedules.length);\n\n// æ ¼å¼åŒ–é€šçŸ¥è¨Šæ¯ - ä¿®æ­£ä½œç”¨åŸŸå•é¡Œ\nfunction formatScheduleMessage(taipeiNow, calgaryNow, jenSchedule, othersSchedules, displayDay, targetDate, isShowingTomorrow, calgaryOffset) {\n  const taipeiDateStr = taipeiNow.toLocaleDateString('zh-TW', {\n    year: 'numeric',\n    month: 'numeric', \n    day: 'numeric',\n    weekday: 'short'\n  });\n  \n  const taipeiTimeStr = taipeiNow.toLocaleTimeString('zh-TW', {\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: false\n  });\n  \n  const calgaryDateStr = calgaryNow.toLocaleDateString('en-CA', {\n    year: 'numeric',\n    month: 'numeric',\n    day: 'numeric', \n    weekday: 'short'\n  });\n  \n  const calgaryTimeStr = calgaryNow.toLocaleTimeString('en-CA', {\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: true\n  });\n  \n  // è¨ˆç®—ç›®æ¨™æ—¥æœŸçš„é¡¯ç¤ºæ ¼å¼\n  const targetDateObj = new Date(targetDate + 'T12:00:00');\n  const targetDateStr = targetDateObj.toLocaleDateString('zh-TW', {\n    month: 'numeric',\n    day: 'numeric', \n    weekday: 'short'\n  });\n  \n  // é¡¯ç¤ºæ™‚å€è³‡è¨Š\n  const timeZoneInfo = calgaryOffset === -6 * 60 ? 'MDT (UTC-6)' : 'MST (UTC-7)';\n  \n  let message = `ğŸ Jen ${displayDay}ç­è¡¨æé†’\\n\\n`;\n  message += `âš ï¸ æ™‚å€æé†’ï¼šé€™æ˜¯ Jen åœ¨å¡åŠ åˆ©çš„ã€Œ${displayDay}ã€ç­è¡¨ï¼\\n`;\n  message += `ğŸ“… å°åŒ—ç¾åœ¨ï¼š${taipeiDateStr} ${taipeiTimeStr}\\n`;\n  message += `ğŸ“… å¡åŠ åˆ©ç¾åœ¨ï¼š${calgaryDateStr} ${calgaryTimeStr} (${timeZoneInfo})\\n\\n`;\n  \n  // Jen çš„ç­è¡¨\n  if (jenSchedule) {\n    message += `ğŸ‘¤ Jen çš„å¡åŠ åˆ©${displayDay}ç­æ¬¡ (${targetDateStr})ï¼š\\n`;\n    \n    if (jenSchedule.status === 'OFF') {\n      message += `ğŸ  ä¼‘å‡\\n`;\n    } else {\n      const timeInfo = jenSchedule.shiftTime;\n      if (timeInfo) {\n        message += `â° ${timeInfo} (å¡åŠ åˆ©æ™‚é–“)\\n`;\n      }\n      message += `ğŸ“ ç‹€æ…‹: ${jenSchedule.status}\\n`;\n      if (jenSchedule.location) {\n        message += `ğŸ“ ä½ç½®: ${jenSchedule.location}\\n`;\n      }\n    }\n  } else {\n    message += `ğŸ‘¤ Jen çš„å¡åŠ åˆ©${displayDay}ç­æ¬¡ (${targetDateStr})ï¼š\\n`;\n    message += `â“ æŸ¥ç„¡è³‡æ–™\\n`;\n  }\n  \n  message += `\\nğŸ‘¥ åŒæ—¥å…¶ä»–åŒäº‹ï¼š\\n`;\n  \n  if (othersSchedules.length > 0) {\n    othersSchedules.forEach(schedule => {\n      const employeeName = schedule.employee;\n      \n      // Karen çš„é‚è¼¯ï¼šæ ¹æ“š Manager_Location é¡¯ç¤ºä½ç½®\n      if (employeeName.toLowerCase().includes('karen')) {\n        if (schedule.location) {\n          message += `â€¢ ${employeeName}: Manager (${schedule.location})\\n`;\n        } else {\n          message += `â€¢ ${employeeName}: Manager\\n`;\n        }\n      } else {\n        // å…¶ä»–å“¡å·¥çš„é‚è¼¯\n        if (schedule.status === 'OFF') {\n          message += `â€¢ ${employeeName}: ä¼‘å‡\\n`;\n        } else {\n          const timeInfo = schedule.shiftTime || schedule.status;\n          const locationInfo = schedule.location ? ` (${schedule.location})` : '';\n          message += `â€¢ ${employeeName}: ${timeInfo}${locationInfo}\\n`;\n        }\n      }\n    });\n  } else {\n    message += `â€¢ æŸ¥ç„¡å…¶ä»–åŒäº‹è³‡æ–™\\n`;\n  }\n  \n  return message;\n}\n\n// å‘¼å«æ ¼å¼åŒ–å‡½å¼ï¼Œå‚³å…¥æ‰€éœ€çš„åƒæ•¸\nconst notificationMessage = formatScheduleMessage(\n  taipeiNow, \n  calgaryNow, \n  jenTargetSchedule, \n  othersTargetSchedules,\n  displayDay,\n  targetDate,\n  isShowingTomorrow,\n  calgaryOffset\n);\n\nconsole.log('æœ€çµ‚é€šçŸ¥è¨Šæ¯:', notificationMessage);\n\n// å›å‚³è™•ç†çµæœ\nreturn {\n  json: {\n    message: notificationMessage,\n    jenSchedule: jenTargetSchedule,\n    othersSchedules: othersTargetSchedules,\n    targetDate: targetDate,\n    displayDay: displayDay,\n    isShowingTomorrow: isShowingTomorrow,\n    taipeiTime: taipeiNow.toISOString(),\n    calgaryTime: calgaryNow.toISOString(),\n    timeZoneInfo: {\n      taipeiOffset: taipeiOffset / 60,\n      calgaryOffset: calgaryOffset / 60,\n      isDST: calgaryOffset === -6 * 60,\n      timeZoneDisplay: calgaryOffset === -6 * 60 ? 'MDT (UTC-6)' : 'MST (UTC-7)'\n    },\n    debugInfo: {\n      totalItems: items.length,\n      processedDataLength: scheduleData.length,\n      targetSchedulesLength: targetSchedules.length,\n      jenFound: !!jenTargetSchedule,\n      taipeiHour: taipeiHour\n    }\n  }\n};"
      },
      "id": "f5dc57ad-22cd-48fc-abea-5ea9c5cbd196",
      "name": "è™•ç†æ’ç­è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        0
      ]
    },
    {
      "parameters": {
        "channel": "#n8n-work-schedule",
        "text": "={{$json.message}}",
        "otherOptions": {},
        "attachments": []
      },
      "id": "bd7cea7e-3893-4e1d-8142-1ee6051f83fc",
      "name": "ç™¼é€ Slack é€šçŸ¥",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        660,
        0
      ],
      "credentials": {
        "slackApi": {
          "id": "H8RWtu7aOphSXGk5",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8,20 * * *"
            }
          ]
        }
      },
      "id": "9ad9e047-9354-4488-b891-0fd997553866",
      "name": "æ¯æ—¥æ—©æ™š 8:00 è§¸ç™¼",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "è®€å–æ’ç­è¡¨": {
      "main": [
        [
          {
            "node": "è™•ç†æ’ç­è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è™•ç†æ’ç­è³‡æ–™": {
      "main": [
        [
          {
            "node": "ç™¼é€ Slack é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¯æ—¥æ—©æ™š 8:00 è§¸ç™¼": {
      "main": [
        [
          {
            "node": "è®€å–æ’ç­è¡¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d6d750dc-23d3-4723-9a5e-9773b89132d5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4f325a7cd315a1a79ed49dc0c3f91bbcfea6ece3018280e4ffc9f22ce531b657"
  },
  "id": "IpjZzAXLRwSjcLza",
  "tags": []
}